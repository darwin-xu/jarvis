<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css"
        />
        <style>
            * {
                box-sizing: border-box;
            }

            html,
            body {
                height: 100vh;
                margin: 0;
                padding: 0;
                font-family:
                    -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
                    sans-serif;
                background-color: #1e1e1e;
                color: #ffffff;
                overflow: hidden;
            }

            .container {
                display: flex;
                flex-direction: column;
                height: 100vh;
                width: 100vw;
            }

            .main-content {
                display: flex;
                flex: 1;
                min-height: 0;
                position: relative;
            }

            .terminal-section {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-width: 0;
            }

            .ai-assistant-pane {
                position: absolute;
                top: 0;
                right: 0;
                width: 400px;
                height: 100%;
                background-color: #2d2d2d;
                border-left: 1px solid #404040;
                display: flex;
                flex-direction: column;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                z-index: 1000;
                box-shadow: -2px 0 8px rgba(0, 0, 0, 0.3);
            }

            .ai-assistant-pane.open {
                transform: translateX(0);
            }

            .ai-assistant-header {
                padding: 12px 16px;
                background-color: #363636;
                border-bottom: 1px solid #404040;
                display: flex;
                align-items: center;
                justify-content: space-between;
                font-size: 14px;
                font-weight: 600;
            }

            .ai-assistant-header .header-buttons {
                display: flex;
                gap: 4px;
                align-items: center;
            }

            .ai-assistant-header .config-btn,
            .ai-assistant-header .close-btn {
                background: none;
                border: none;
                color: #ffffff;
                cursor: pointer;
                padding: 4px;
                border-radius: 2px;
                font-size: 16px;
                line-height: 1;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .ai-assistant-header .config-btn:hover,
            .ai-assistant-header .close-btn:hover {
                background-color: #404040;
            }

            .ai-chat-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
            }

            .ai-chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 16px;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .ai-message {
                max-width: 85%;
                padding: 8px 12px;
                border-radius: 12px;
                font-size: 14px;
                line-height: 1.4;
                word-wrap: break-word;
            }

            .ai-message.user {
                align-self: flex-end;
                background-color: #007acc;
                color: white;
            }

            .ai-message.assistant {
                align-self: flex-start;
                background-color: #404040;
                color: #ffffff;
            }

            .ai-message.command {
                align-self: flex-start;
                background-color: #2d4a2d;
                color: #90ee90;
                border: 1px solid #4a6b4a;
                font-family: 'Courier New', monospace;
            }

            .ai-message.command-output {
                align-self: flex-start;
                background-color: #1a1a1a;
                color: #f0f0f0;
                border: 1px solid #404040;
                font-family: 'Courier New', monospace;
                white-space: pre-wrap;
                max-width: 95%;
            }

            .ai-message.error {
                align-self: flex-start;
                background-color: #4d2626;
                color: #ffaaaa;
                border: 1px solid #6b4a4a;
            }

            .ai-input-container {
                padding: 16px;
                border-top: 1px solid #404040;
                display: flex;
                gap: 8px;
            }

            .ai-input {
                flex: 1;
                padding: 8px 12px;
                border: 1px solid #404040;
                border-radius: 20px;
                background-color: #3c3c3c;
                color: #ffffff;
                font-size: 14px;
                outline: none;
                resize: none;
                min-height: 36px;
                max-height: 120px;
            }

            .ai-input:focus {
                border-color: #007acc;
                box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.3);
            }

            .ai-send-btn {
                padding: 8px 16px;
                background-color: #007acc;
                color: white;
                border: none;
                border-radius: 20px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
                align-self: flex-end;
            }

            .ai-send-btn:hover {
                background-color: #005a9e;
            }

            .ai-send-btn:disabled {
                background-color: #404040;
                cursor: not-allowed;
            }

            .ai-toggle-hint {
                position: fixed;
                top: 50%;
                right: 16px;
                transform: translateY(-50%);
                background-color: rgba(0, 0, 0, 0.8);
                color: #ffffff;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                font-family: monospace;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
                z-index: 1000;
            }

            .ai-toggle-hint.show {
                opacity: 1;
            }

            .config-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            }

            .config-modal {
                background-color: #2d2d2d;
                border: 1px solid #404040;
                border-radius: 8px;
                width: 90%;
                max-width: 500px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            }

            .config-header {
                padding: 16px 20px;
                background-color: #363636;
                border-bottom: 1px solid #404040;
                border-radius: 8px 8px 0 0;
                display: flex;
                align-items: center;
                justify-content: space-between;
                font-size: 16px;
                font-weight: 600;
            }

            .config-content {
                padding: 20px;
            }

            .config-section {
                margin-bottom: 24px;
            }

            .config-section:last-child {
                margin-bottom: 0;
            }

            .config-label {
                display: block;
                font-size: 14px;
                font-weight: 500;
                color: #ffffff;
                margin-bottom: 8px;
            }

            .llm-options {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .llm-option {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px;
                border: 1px solid #404040;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .llm-option:hover {
                background-color: #3c3c3c;
            }

            .llm-option.selected {
                border-color: #007acc;
                background-color: rgba(0, 122, 204, 0.1);
            }

            .llm-option input[type='radio'] {
                margin: 0;
            }

            .llm-option-info {
                flex: 1;
            }

            .llm-option-name {
                font-size: 14px;
                font-weight: 500;
                color: #ffffff;
            }

            .llm-option-desc {
                font-size: 12px;
                color: #cccccc;
                margin-top: 2px;
            }

            .custom-url-input {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #404040;
                border-radius: 4px;
                background-color: #3c3c3c;
                color: #ffffff;
                font-size: 14px;
                margin-top: 8px;
            }

            .custom-url-input:focus {
                outline: none;
                border-color: #007acc;
                box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.3);
            }

            .custom-url-input:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .config-buttons {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
                margin-top: 20px;
                padding-top: 16px;
                border-top: 1px solid #404040;
            }

            .config-btn-primary,
            .config-btn-secondary {
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
            }

            .config-btn-primary {
                background-color: #007acc;
                color: white;
            }

            .config-btn-primary:hover {
                background-color: #005a9e;
            }

            .config-btn-secondary {
                background-color: #404040;
                color: #ffffff;
            }

            .config-btn-secondary:hover {
                background-color: #4a4a4a;
            }

            #connect-form {
                flex-shrink: 0;
                padding: 15px;
                background-color: #2d2d2d;
                border-bottom: 1px solid #404040;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                align-items: center;
            }

            #connect-form input {
                padding: 8px 12px;
                border: 1px solid #404040;
                border-radius: 4px;
                background-color: #3c3c3c;
                color: #ffffff;
                font-size: 14px;
                min-width: 120px;
                flex: 1;
            }

            #connect-form input:focus {
                outline: none;
                border-color: #007acc;
                box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.3);
            }

            #connect-form button {
                padding: 8px 16px;
                background-color: #007acc;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
            }

            #connect-form button:hover {
                background-color: #005a9e;
            }

            #connect-form label {
                font-size: 14px;
                font-weight: 500;
                white-space: nowrap;
            }

            #terminal-container {
                flex: 1;
                min-height: 0;
                padding: 0;
                background-color: #000000;
                position: relative;
            }

            #terminal {
                width: 100%;
                height: 100%;
            }

            .status {
                position: absolute;
                top: 10px;
                right: 10px;
                background-color: rgba(0, 0, 0, 0.8);
                color: #00ff00;
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 12px;
                font-family: monospace;
                display: none;
            }

            #login-overlay {
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10;
            }

            #login-form {
                background-color: #2d2d2d;
                padding: 15px;
                border-radius: 4px;
                display: flex;
                gap: 10px;
                align-items: center;
            }

            @media (max-width: 768px) {
                #connect-form {
                    flex-direction: column;
                    align-items: stretch;
                }

                #connect-form input {
                    min-width: auto;
                }

                .ai-assistant-pane {
                    width: 100%;
                    transform: translateX(100%);
                }

                .ai-assistant-pane.open {
                    transform: translateX(0);
                }

                .ai-toggle-hint {
                    display: none;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div
                id="login-overlay"
                role="dialog"
                aria-modal="true"
                style="display: none"
            >
                <form id="login-form">
                    <label for="server-pass">Server Password:</label>
                    <input id="server-pass" type="password" required />
                    <button type="submit">Login</button>
                </form>
            </div>
            <form id="connect-form">
                <label for="host">Host:</label>
                <input
                    id="host"
                    name="host"
                    placeholder="hostname or IP"
                    required
                />
                <label for="user">User:</label>
                <input id="user" name="user" placeholder="username" required />
                <label for="pass">Password:</label>
                <input
                    id="pass"
                    name="pass"
                    type="password"
                    placeholder="password"
                    required
                />
                <button type="submit">Connect</button>
            </form>
            <div class="main-content">
                <div class="terminal-section">
                    <div id="terminal-container">
                        <div id="terminal"></div>
                        <div class="status" id="status">Connected</div>
                    </div>
                </div>
                <div class="ai-assistant-pane" id="ai-assistant-pane">
                    <div class="ai-assistant-header">
                        <span>AI Assistant</span>
                        <div class="header-buttons">
                            <button
                                class="config-btn"
                                onclick="openConfigModal()"
                                title="Configuration"
                            >
                                ⚙
                            </button>
                            <button
                                class="close-btn"
                                onclick="toggleAIAssistant()"
                                title="Close"
                            >
                                ×
                            </button>
                        </div>
                    </div>
                    <div class="ai-chat-container">
                        <div class="ai-chat-messages" id="ai-chat-messages">
                            <div class="ai-message assistant">
                                Hi! I'm your AI assistant. I can help you with
                                terminal commands, troubleshooting, and provide
                                explanations. To execute commands directly in
                                the terminal, use these prefixes:<br />
                                • /cmd &ltcommand&gt - Execute terminal
                                command<br />
                                • /exec &ltommand&gt - Execute terminal
                                command<br />

                                Example: /cmd ls -la Press Cmd+I to toggle this
                                pane.
                            </div>
                        </div>
                        <div class="ai-input-container">
                            <textarea
                                class="ai-input"
                                id="ai-input"
                                placeholder="How can I assist you?"
                                rows="1"
                            ></textarea>
                            <button
                                class="ai-send-btn"
                                id="ai-send-btn"
                                onclick="sendAIMessage()"
                            >
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ai-toggle-hint" id="ai-toggle-hint">
                Press Cmd+I to toggle AI Assistant
            </div>

            <!-- Config Modal -->
            <div class="config-overlay" id="config-overlay">
                <div class="config-modal">
                    <div class="config-header">
                        <span>AI Assistant Configuration</span>
                        <button class="close-btn" onclick="closeConfigModal()">
                            ×
                        </button>
                    </div>
                    <div class="config-content">
                        <div class="config-section">
                            <label class="config-label"
                                >Choose LLM Provider:</label
                            >
                            <div class="llm-options">
                                <label
                                    class="llm-option"
                                    onclick="selectLLMProvider('openai')"
                                >
                                    <input
                                        type="radio"
                                        name="llm-provider"
                                        value="openai"
                                    />
                                    <div class="llm-option-info">
                                        <div class="llm-option-name">
                                            OpenAI
                                        </div>
                                        <div class="llm-option-desc">
                                            GPT models from OpenAI
                                        </div>
                                    </div>
                                </label>
                                <label
                                    class="llm-option"
                                    onclick="selectLLMProvider('openrouter')"
                                >
                                    <input
                                        type="radio"
                                        name="llm-provider"
                                        value="openrouter"
                                    />
                                    <div class="llm-option-info">
                                        <div class="llm-option-name">
                                            OpenRouter
                                        </div>
                                        <div class="llm-option-desc">
                                            Access to multiple LLM providers
                                        </div>
                                    </div>
                                </label>
                                <label
                                    class="llm-option"
                                    onclick="selectLLMProvider('custom')"
                                >
                                    <input
                                        type="radio"
                                        name="llm-provider"
                                        value="custom"
                                    />
                                    <div class="llm-option-info">
                                        <div class="llm-option-name">
                                            Custom
                                        </div>
                                        <div class="llm-option-desc">
                                            Your own API endpoint
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <input
                                type="text"
                                class="custom-url-input"
                                id="custom-url-input"
                                placeholder="Enter custom API URL..."
                                disabled
                            />
                        </div>
                        <div class="config-buttons">
                            <button
                                class="config-btn-secondary"
                                onclick="closeConfigModal()"
                            >
                                Cancel
                            </button>
                            <button
                                class="config-btn-primary"
                                onclick="saveConfig()"
                            >
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
        <script>
            let term;
            let fitAddon;
            let socket;
            let isConnected = false;
            let reconnectTimeout;
            let reconnectAttempts = 0;
            const MAX_RECONNECT_ATTEMPTS = 5;
            let waitingForKey = false;
            let manualClose = false;
            let pingTimer;
            let bufferIndex = 0;
            const PING_INTERVAL = 15000;

            function log(...args) {
                console.log(new Date().toISOString(), ...args);
            }

            function showConnectForm() {
                document.getElementById('connect-form').style.display = 'flex';
            }

            function scheduleReconnect() {
                const stored = localStorage.getItem('sessionId');
                if (!stored) {
                    showConnectForm();
                    return;
                }
                if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                    updateStatus(
                        'Retry limit reached. Press any key to retry.',
                        true
                    );
                    waitingForKey = true;
                    return;
                }
                const delay = Math.min(
                    15000,
                    1000 * Math.pow(2, reconnectAttempts)
                );
                log(
                    `Scheduling reconnect attempt ${reconnectAttempts + 1} in ${delay}ms`
                );
                updateStatus(
                    `Reconnecting in ${Math.round(delay / 1000)}s...`,
                    true
                );
                reconnectTimeout = setTimeout(() => {
                    reconnectAttempts++;
                    startConnection(
                        `sessionId=${encodeURIComponent(stored)}&since=${bufferIndex}`
                    );
                }, delay);
            }

            function handleKeyRetry() {
                if (!waitingForKey) {
                    return;
                }
                waitingForKey = false;
                reconnectAttempts = 0;
                log('Manual key press triggered reconnect');
                const stored = localStorage.getItem('sessionId');
                if (stored) {
                    startConnection(
                        `sessionId=${encodeURIComponent(stored)}&since=${bufferIndex}`
                    );
                }
            }

            function clearReconnect() {
                if (reconnectTimeout) {
                    clearTimeout(reconnectTimeout);
                    reconnectTimeout = null;
                    reconnectAttempts = 0;
                    waitingForKey = false;
                }
            }

            function terminateSession() {
                const stored = localStorage.getItem('sessionId');
                if (!stored) {
                    return;
                }
                fetch('/sessions/terminate', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: stored }),
                }).catch(err => console.warn('Terminate session failed', err));
                localStorage.removeItem('sessionId');
            }

            async function checkAuth() {
                const res = await fetch('/auth/check', {
                    credentials: 'include',
                });
                const data = await res.json();
                return data.authenticated;
            }

            async function requireAuth() {
                const ok = await checkAuth();
                const overlay = document.getElementById('login-overlay');
                overlay.style.display = ok ? 'none' : 'flex';
                return ok;
            }

            document
                .getElementById('login-form')
                .addEventListener('submit', async e => {
                    e.preventDefault();
                    const pw = document.getElementById('server-pass').value;
                    const resp = await fetch('/auth/login', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: pw }),
                    });
                    if (resp.ok) {
                        document.getElementById('login-overlay').style.display =
                            'none';
                    } else {
                        alert('Invalid password');
                    }
                });

            // Function to resize terminal to fit container
            function resizeTerminal() {
                if (term && fitAddon) {
                    try {
                        fitAddon.fit();
                        log(`Terminal resized to: ${term.cols}x${term.rows}`);

                        // Send resize info to server if connected
                        if (
                            socket &&
                            socket.readyState === WebSocket.OPEN &&
                            isConnected
                        ) {
                            const { cols, rows } = term;
                            socket.send(
                                JSON.stringify({
                                    type: 'resize',
                                    cols: cols,
                                    rows: rows,
                                })
                            );
                        }
                    } catch (error) {
                        console.warn('Error resizing terminal:', error);
                    }
                }
            }

            // Debounce resize function to avoid excessive calls
            let resizeTimeout;
            function debouncedResize() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(resizeTerminal, 100);
            }

            // Function to initialize terminal with proper sizing
            function initializeTerminal() {
                // Initialize terminal with responsive options
                term = new Terminal({
                    cursorBlink: true,
                    fontSize: 14,
                    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                    theme: {
                        background: '#000000',
                        foreground: '#ffffff',
                        cursor: '#ffffff',
                        selection: 'rgba(255, 255, 255, 0.3)',
                    },
                });

                // Fit addon for automatic resizing
                fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);

                const terminalElement = document.getElementById('terminal');
                term.open(terminalElement);

                // Wait for the DOM to be fully rendered and CSS applied
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        // Check if container has proper dimensions
                        const container =
                            document.getElementById('terminal-container');
                        log(
                            `Container dimensions: ${container.offsetWidth}x${container.offsetHeight}`
                        );

                        // Multiple resize attempts to ensure proper sizing
                        resizeTerminal();
                        setTimeout(resizeTerminal, 50);
                        setTimeout(resizeTerminal, 150);
                        setTimeout(resizeTerminal, 300);
                    });
                });

                // Listen for window resize events
                window.addEventListener('resize', debouncedResize);

                // Listen for orientation change on mobile devices
                window.addEventListener('orientationchange', () => {
                    setTimeout(debouncedResize, 500);
                });

                // Handle terminal focus/blur for better UX
                term.onFocus(() => {
                    document.getElementById(
                        'terminal-container'
                    ).style.borderColor = '#007acc';
                });

                term.onBlur(() => {
                    document.getElementById(
                        'terminal-container'
                    ).style.borderColor = 'transparent';
                });

                // Focus terminal
                term.focus();
            }

            // Initialize terminal when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener(
                    'DOMContentLoaded',
                    initializeTerminal
                );
            } else {
                initializeTerminal();
            }

            function updateStatus(message, isError = false) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.style.display = 'block';
                status.style.color = isError ? '#ff6b6b' : '#00ff00';

                if (!isError) {
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                }
            }

            function startConnection(query) {
                const wsProtocol =
                    location.protocol === 'https:' ? 'wss:' : 'ws:';
                manualClose = false;
                clearReconnect();
                clearInterval(pingTimer);
                log('Opening WebSocket');
                socket = new WebSocket(
                    `${wsProtocol}//${location.host}/terminal?${query}`
                );

                socket.onopen = () => {
                    isConnected = true;
                    log('WebSocket opened');
                    updateStatus('SSH connecting...');
                    document.getElementById('connect-form').style.display =
                        'none';
                    clearReconnect();
                    pingTimer = setInterval(() => {
                        if (socket && socket.readyState === WebSocket.OPEN) {
                            log('Sending ping');
                            socket.send(JSON.stringify({ type: 'ping' }));
                        }
                    }, PING_INTERVAL);
                };

                socket.onmessage = e => {
                    try {
                        const data = JSON.parse(e.data);
                        if (data.type === 'ping') {
                            log('Received ping from server');
                            socket.send(JSON.stringify({ type: 'pong' }));
                            log('Sent pong to server');
                            return;
                        }
                        if (data.type === 'pong') {
                            log('Received pong from server');
                            return;
                        }
                        if (data.type === 'error') {
                            updateStatus(data.message, true);
                            clearReconnect();
                            if (
                                data.message.includes('Invalid session') ||
                                data.message.includes('Missing SSH')
                            ) {
                                manualClose = true;
                                localStorage.removeItem('sessionId');
                            }
                            showConnectForm();
                        } else if (data.type === 'ready') {
                            clearReconnect();
                            if (data.sessionId) {
                                localStorage.setItem(
                                    'sessionId',
                                    data.sessionId
                                );
                            }
                            updateStatus('Connected');
                            const sendTerminalSize = () => {
                                if (term && fitAddon) {
                                    try {
                                        fitAddon.fit();
                                        const { cols, rows } = term;
                                        socket.send(
                                            JSON.stringify({
                                                type: 'resize',
                                                cols,
                                                rows,
                                            })
                                        );
                                    } catch (error) {
                                        console.warn(
                                            'Error sending terminal size:',
                                            error
                                        );
                                    }
                                }
                            };
                            sendTerminalSize();
                            setTimeout(sendTerminalSize, 100);
                        }
                    } catch {
                        // Capture output for command execution
                        captureTerminalOutput(e.data);

                        console.log('Received data------:', e.data);

                        term.write(e.data);
                        bufferIndex++;
                    }
                };

                socket.onclose = event => {
                    isConnected = false;
                    clearInterval(pingTimer);
                    log('WebSocket closed', event);
                    if (event.wasClean) {
                        updateStatus('Connection closed', true);
                    } else {
                        updateStatus('Connection lost', true);
                    }
                    if (manualClose) {
                        term.write('\r\n\x1b[31mConnection closed.\x1b[0m\r\n');
                        bufferIndex = 0;
                        showConnectForm();
                    } else {
                        scheduleReconnect();
                    }
                };

                socket.onerror = () => {
                    isConnected = false;
                    clearInterval(pingTimer);
                    log('WebSocket error');
                    updateStatus('Connection failed', true);
                    if (!manualClose) {
                        scheduleReconnect();
                    } else {
                        bufferIndex = 0;
                        showConnectForm();
                    }
                };

                if (window.dataDisposable) {
                    window.dataDisposable.dispose();
                }
                window.dataDisposable = term.onData(data => {
                    handleKeyRetry();
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ type: 'data', data }));
                    }
                });
            }

            document
                .getElementById('connect-form')
                .addEventListener('submit', async e => {
                    e.preventDefault();

                    if (!(await requireAuth())) {
                        return;
                    }

                    if (socket) {
                        manualClose = true;
                        clearReconnect();
                        clearInterval(pingTimer);
                        log('Closing existing WebSocket');
                        socket.close();
                        terminateSession();
                    }

                    const host = document.getElementById('host').value.trim();
                    const user = document.getElementById('user').value.trim();
                    const pass = document.getElementById('pass').value;

                    if (!host || !user || !pass) {
                        updateStatus('Please fill in all fields', true);
                        return;
                    }

                    updateStatus('Connecting...');
                    log(`Connecting to ${host} as ${user}`);
                    bufferIndex = 0;
                    const query = `host=${encodeURIComponent(host)}&user=${encodeURIComponent(user)}&pass=${encodeURIComponent(pass)}`;
                    startConnection(query);
                });

            (async () => {
                if (await requireAuth()) {
                    const stored = localStorage.getItem('sessionId');
                    if (stored) {
                        startConnection(
                            `sessionId=${encodeURIComponent(stored)}`
                        );
                    }
                }
            })();

            window.addEventListener('beforeunload', () => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    manualClose = true;
                    clearInterval(pingTimer);
                    log('Closing WebSocket before unload');
                    socket.close();
                }
            });
            window.addEventListener('keydown', handleKeyRetry);

            // AI Assistant functionality
            let aiAssistantOpen = false;
            let aiMessages = [];
            let currentLLMProvider = 'openai'; // default
            let customApiUrl = '';
            let commandOutputLog = []; // Store command outputs for AI context
            let isExecutingCommand = false;
            let commandOutputBuffer = '';
            let commandStartTime = null;

            // Config modal functions
            function openConfigModal() {
                const overlay = document.getElementById('config-overlay');
                overlay.style.display = 'flex';

                // Load current settings
                loadConfigSettings();
            }

            function closeConfigModal() {
                const overlay = document.getElementById('config-overlay');
                overlay.style.display = 'none';
            }

            function loadConfigSettings() {
                // Load from localStorage
                const savedProvider =
                    localStorage.getItem('llm-provider') || 'openai';
                const savedCustomUrl =
                    localStorage.getItem('custom-api-url') || '';

                currentLLMProvider = savedProvider;
                customApiUrl = savedCustomUrl;

                // Update UI
                const radioButton = document.querySelector(
                    `input[name="llm-provider"][value="${savedProvider}"]`
                );
                if (radioButton) {
                    radioButton.checked = true;
                    updateLLMOptionSelection(savedProvider);
                }

                const customUrlInput =
                    document.getElementById('custom-url-input');
                customUrlInput.value = savedCustomUrl;
                customUrlInput.disabled = savedProvider !== 'custom';
            }

            function selectLLMProvider(provider) {
                const radioButton = document.querySelector(
                    `input[name="llm-provider"][value="${provider}"]`
                );
                if (radioButton) {
                    radioButton.checked = true;
                }

                updateLLMOptionSelection(provider);
                currentLLMProvider = provider;
            }

            function updateLLMOptionSelection(provider) {
                // Remove selected class from all options
                document.querySelectorAll('.llm-option').forEach(option => {
                    option.classList.remove('selected');
                });

                // Add selected class to current option
                const selectedOption = document
                    .querySelector(
                        `input[name="llm-provider"][value="${provider}"]`
                    )
                    .closest('.llm-option');
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }

                // Enable/disable custom URL input
                const customUrlInput =
                    document.getElementById('custom-url-input');
                customUrlInput.disabled = provider !== 'custom';

                if (provider === 'custom') {
                    customUrlInput.focus();
                }
            }

            function saveConfig() {
                const selectedProvider =
                    document.querySelector('input[name="llm-provider"]:checked')
                        ?.value || 'openai';
                const customUrl = document
                    .getElementById('custom-url-input')
                    .value.trim();

                // Validate custom URL if selected
                if (selectedProvider === 'custom' && !customUrl) {
                    alert('Please enter a custom API URL');
                    return;
                }

                // Save to localStorage
                localStorage.setItem('llm-provider', selectedProvider);
                localStorage.setItem('custom-api-url', customUrl);

                // Update current settings
                currentLLMProvider = selectedProvider;
                customApiUrl = customUrl;

                closeConfigModal();

                // Show confirmation
                addAIMessage(
                    `Configuration updated! Using ${selectedProvider === 'custom' ? 'custom API' : selectedProvider} provider.`,
                    false
                );
            }

            // Close modal when clicking outside
            document
                .getElementById('config-overlay')
                .addEventListener('click', e => {
                    if (e.target.id === 'config-overlay') {
                        closeConfigModal();
                    }
                });

            // Handle Enter key in custom URL input
            document
                .getElementById('custom-url-input')
                .addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveConfig();
                    }
                });

            // Command execution functionality
            function executeCommand(command) {
                if (
                    !socket ||
                    socket.readyState !== WebSocket.OPEN ||
                    !isConnected
                ) {
                    addAIMessage(
                        '❌ Error: Terminal not connected. Please connect to SSH first.',
                        false,
                        'error'
                    );
                    return;
                }

                if (isExecutingCommand) {
                    addAIMessage(
                        '❌ Error: Another command is already executing. Please wait.',
                        false,
                        'error'
                    );
                    return;
                }

                // Reset command state
                isExecutingCommand = true;
                commandOutputBuffer = '';
                commandStartTime = Date.now();

                // Add command to AI chat
                addAIMessage(`🔧 Executing: ${command}`, false, 'command');

                // Send command to terminal
                const commandToSend = command.trim() + '\n';
                socket.send(
                    JSON.stringify({ type: 'data', data: commandToSend })
                );

                // Set a timeout to stop capturing output after 10 seconds
                setTimeout(() => {
                    if (isExecutingCommand) {
                        finishCommandExecution(command, true);
                    }
                }, 10000);
            }

            function finishCommandExecution(command, isTimeout = false) {
                if (!isExecutingCommand) return;

                isExecutingCommand = false;
                const executionTime = Date.now() - commandStartTime;

                // Clean up the output buffer
                let cleanOutput = commandOutputBuffer
                    .replace(/\x1b\[[0-9;]*m/g, '') // Remove ANSI color codes
                    .replace(/\r\n/g, '\n')
                    .replace(/\r/g, '\n')
                    .trim();

                // Log command and output
                const logEntry = {
                    command: command,
                    output: cleanOutput,
                    timestamp: new Date().toISOString(),
                    executionTime: executionTime,
                    isTimeout: isTimeout,
                };
                commandOutputLog.push(logEntry);

                // Keep only last 50 commands in memory
                if (commandOutputLog.length > 50) {
                    commandOutputLog.shift();
                }

                // Save to localStorage for persistence
                try {
                    localStorage.setItem(
                        'command-output-log',
                        JSON.stringify(commandOutputLog.slice(-20))
                    ); // Keep last 20 in storage
                } catch (e) {
                    console.warn(
                        'Failed to save command log to localStorage:',
                        e
                    );
                }

                // Also save to server
                saveCommandToServer(logEntry);

                // Display result in AI chat
                if (isTimeout) {
                    addAIMessage(
                        '⏰ Command execution timeout (10s). Output captured so far:',
                        false,
                        'error'
                    );
                } else {
                    addAIMessage(
                        `✅ Command completed in ${executionTime}ms`,
                        false,
                        'command'
                    );
                }

                if (cleanOutput) {
                    addAIMessage(
                        `📄 Output:\n${cleanOutput}`,
                        false,
                        'command-output'
                    );
                } else {
                    addAIMessage('📄 No output captured', false, 'command');
                }

                // Reset buffer
                commandOutputBuffer = '';
            }

            function captureTerminalOutput(data) {
                if (isExecutingCommand) {
                    commandOutputBuffer += data;

                    // Check if command has finished (look for prompt patterns)
                    // This is a simple heuristic - you might need to adjust based on your shell
                    if (
                        data.includes('$ ') ||
                        data.includes('# ') ||
                        data.includes('> ') ||
                        data.includes('bash-') ||
                        data.includes(': ~') ||
                        data.includes(']:')
                    ) {
                        console.log(
                            'Command prompt detected, finishing execution...'
                        );
                        // Delay a bit to ensure we capture the full output
                        setTimeout(() => {
                            if (isExecutingCommand) {
                                // Get the last command from history
                                const lastLog =
                                    commandOutputLog[
                                        commandOutputLog.length - 1
                                    ];
                                if (
                                    lastLog &&
                                    Date.now() - commandStartTime > 500
                                ) {
                                    // At least 500ms since start
                                    finishCommandExecution(
                                        lastLog.command || 'unknown'
                                    );
                                }
                            }
                        }, 200);
                    }
                }
            }

            function parseCommand(message) {
                // Check if message starts with command prefixes
                const commandPrefixes = ['/cmd', '/command', '/exec', '/run'];
                const lowercaseMessage = message.toLowerCase().trim();

                for (const prefix of commandPrefixes) {
                    if (lowercaseMessage.startsWith(prefix + ' ')) {
                        return message.substring(prefix.length + 1).trim();
                    }
                }

                return null;
            }

            function loadCommandHistory() {
                try {
                    const saved = localStorage.getItem('command-output-log');
                    if (saved) {
                        commandOutputLog = JSON.parse(saved);
                    }
                } catch (e) {
                    console.warn('Failed to load command history:', e);
                    commandOutputLog = [];
                }
            }

            async function saveCommandToServer(logEntry) {
                try {
                    const sessionId =
                        localStorage.getItem('sessionId') || 'unknown';
                    const response = await fetch('/api/command-log', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...logEntry,
                            sessionId: sessionId,
                        }),
                    });

                    if (!response.ok) {
                        console.warn(
                            'Failed to save command log to server:',
                            response.statusText
                        );
                    }
                } catch (error) {
                    console.warn('Error saving command log to server:', error);
                }
            }

            function getCommandHistory() {
                return commandOutputLog.slice(); // Return a copy
            }

            function getRecentCommandContext(limit = 5) {
                const recent = commandOutputLog.slice(-limit);
                return recent.map(entry => ({
                    command: entry.command,
                    output: entry.output,
                    timestamp: entry.timestamp,
                    success:
                        !entry.output.toLowerCase().includes('error') &&
                        !entry.output
                            .toLowerCase()
                            .includes('command not found'),
                }));
            }

            function formatCommandContextForAI() {
                const context = getRecentCommandContext();
                if (context.length === 0) {
                    return 'No recent commands executed.';
                }

                return (
                    'Recent command history:\n' +
                    context
                        .map(
                            cmd =>
                                `Command: ${cmd.command}\nOutput: ${cmd.output.substring(0, 200)}${cmd.output.length > 200 ? '...' : ''}\nStatus: ${cmd.success ? 'Success' : 'Error'}\n`
                        )
                        .join('\n---\n')
                );
            }

            // Load command history on page load
            loadCommandHistory();

            function toggleAIAssistant() {
                const pane = document.getElementById('ai-assistant-pane');
                const hint = document.getElementById('ai-toggle-hint');

                aiAssistantOpen = !aiAssistantOpen;

                if (aiAssistantOpen) {
                    pane.classList.add('open');
                    hint.classList.remove('show');
                    // Focus on the AI input when opening
                    setTimeout(() => {
                        document.getElementById('ai-input').focus();
                    }, 300);
                } else {
                    pane.classList.remove('open');
                    // Return focus to terminal when closing
                    if (term) {
                        term.focus();
                    }
                }
            }

            function showAIToggleHint() {
                if (!aiAssistantOpen) {
                    const hint = document.getElementById('ai-toggle-hint');
                    hint.classList.add('show');
                    setTimeout(() => {
                        hint.classList.remove('show');
                    }, 3000);
                }
            }

            function addAIMessage(
                content,
                isUser = false,
                messageType = 'normal'
            ) {
                const messagesContainer =
                    document.getElementById('ai-chat-messages');
                const messageDiv = document.createElement('div');

                let className = `ai-message ${isUser ? 'user' : 'assistant'}`;

                // Apply special styling for different message types
                if (!isUser) {
                    if (messageType === 'command') {
                        className = 'ai-message command';
                    } else if (messageType === 'command-output') {
                        className = 'ai-message command-output';
                    } else if (messageType === 'error') {
                        className = 'ai-message error';
                    }
                }

                messageDiv.className = className;
                messageDiv.textContent = content;
                messagesContainer.appendChild(messageDiv);

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Store message
                aiMessages.push({
                    content,
                    isUser,
                    messageType,
                    timestamp: Date.now(),
                });
            }

            function sendAIMessage() {
                const input = document.getElementById('ai-input');
                const sendBtn = document.getElementById('ai-send-btn');
                const message = input.value.trim();

                if (!message) return;

                // Add user message
                addAIMessage(message, true);

                // Clear input
                input.value = '';

                // Check if this is a command
                const command = parseCommand(message);
                if (command) {
                    executeCommand(command);
                    return;
                }

                // Regular AI message handling
                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending...';

                // Simulate AI response (placeholder for now)
                setTimeout(() => {
                    const helpText = `I'm a placeholder AI response. To execute commands, use one of these prefixes:
• /cmd <command> - Execute a terminal command
• /command <command> - Execute a terminal command  
• /exec <command> - Execute a terminal command
• /run <command> - Execute a terminal command

Example: /cmd ls -la`;
                    addAIMessage(helpText, false);
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send';
                    input.focus();
                }, 1000);
            }

            // Handle Cmd+I keyboard shortcut
            document.addEventListener('keydown', e => {
                if (e.metaKey && e.key === 'i') {
                    e.preventDefault();
                    toggleAIAssistant();
                }
            });

            // Handle Enter key in AI input
            document
                .getElementById('ai-input')
                .addEventListener('keydown', e => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendAIMessage();
                    }
                });

            // Auto-resize textarea
            document
                .getElementById('ai-input')
                .addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });

            // Show hint on page load
            setTimeout(showAIToggleHint, 2000);
        </script>
    </body>
</html>
